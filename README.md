# AIOps - AI æ™ºèƒ½å†…å®¹è¿è¥ç³»ç»Ÿ

> ç‰ˆæœ¬ï¼šv3.0 (é˜Ÿåˆ—ä¼˜åŒ–ç‰ˆ) | æ›´æ–°æ—¶é—´ï¼š2025-11-27

**åŸºäºæœ¬åœ° Claude Code Shell + ä»»åŠ¡é˜Ÿåˆ—çš„å…¨è‡ªåŠ¨åŒ–å†…å®¹ç”Ÿäº§ä¸è¿è¥å¹³å°**ï¼Œé›¶è´¹ç”¨ AIã€æ•°æ®æœ¬åœ°åŒ–ã€å®Œæ•´é—­ç¯ã€æ­»é”é˜²æŠ¤ã€‚

---

## ğŸ“‘ ç›®å½•

- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [æ ¸å¿ƒåŠŸèƒ½](#æ ¸å¿ƒåŠŸèƒ½)
- [æŠ€æœ¯æ¶æ„](#æŠ€æœ¯æ¶æ„)
- [å­˜å‚¨æ¶æ„](#å­˜å‚¨æ¶æ„)
- [Claude Shell é˜Ÿåˆ—æœåŠ¡](#claude-shell-é˜Ÿåˆ—æœåŠ¡)
- [API æ¥å£](#api-æ¥å£)
- [é…ç½®è¯´æ˜](#é…ç½®è¯´æ˜)
- [æ•…éšœæ’æŸ¥](#æ•…éšœæ’æŸ¥)
- [é¡¹ç›®ç»“æ„](#é¡¹ç›®ç»“æ„)

---

## å¿«é€Ÿå¼€å§‹

### å‰ç½®è¦æ±‚

- Node.js 18+
- Docker & Docker Compose
- **Claude Code CLI** (å¿…éœ€)

### 1. å…‹éš†é¡¹ç›®

```bash
git clone <repository-url>
cd AIOps
```

### 2. å¯åŠ¨åŸºç¡€æœåŠ¡

```bash
docker-compose up -d  # å¯åŠ¨ MongoDBã€Elasticsearchã€Redis
```

### 3. é…ç½®ç¯å¢ƒå˜é‡

```bash
cp .env.example .env
# ç¼–è¾‘ .env é…ç½®æ•°æ®åº“è¿æ¥ä¿¡æ¯
```

### 4. å®‰è£…ä¾èµ–å¹¶å¯åŠ¨

```bash
cd backend
npm install
npm run start:dev
```

### 5. éªŒè¯æœåŠ¡

```bash
# æŸ¥çœ‹é˜Ÿåˆ—çŠ¶æ€
curl http://localhost:3000/ai/queue/status

# æµ‹è¯•çˆ¬è™«
curl -X POST http://localhost:3000/api/crawler/crawl/zhihu
```

---

## æ ¸å¿ƒåŠŸèƒ½

### ğŸ¤– æ™ºèƒ½ AI æœåŠ¡
- **é›¶è´¹ç”¨ AI**ï¼šåŸºäºæœ¬åœ° Claude Code Shell è°ƒç”¨
- **ä»»åŠ¡é˜Ÿåˆ—**ï¼šæœ€å¤š 5 ä¸ªå¹¶å‘ï¼ŒFIFO å…ˆè¿›å…ˆå‡º
- **æ­»é”é˜²æŠ¤**ï¼šè¶…æ—¶æ£€æµ‹ + è‡ªåŠ¨é‡Šæ”¾ + ä¼šè¯éš”ç¦»
- **å†…å®¹ç”Ÿæˆ**ï¼šè‡ªåŠ¨ç”Ÿæˆå°çº¢ä¹¦çˆ†æ¬¾æ–‡æ¡ˆ
- **ç­–ç•¥ä¼˜åŒ–**ï¼šAI åˆ†ææ•°æ®ç”Ÿæˆè¿è¥ç­–ç•¥
- **å†…å®¹åˆ†æ**ï¼šè´¨é‡è¯„åˆ†ã€æƒ…æ„Ÿåˆ†æã€çˆ†æ¬¾é¢„æµ‹

### ğŸ•·ï¸ æ™ºèƒ½çˆ¬è™«
- **çŸ¥ä¹**ï¼šçƒ­æ¦œã€æœç´¢ã€é—®ç­”
- **å¾®ä¿¡å…¬ä¼—å·**ï¼šé€šè¿‡æœç‹—æœç´¢çˆ¬å–
- **AI ç­›é€‰**ï¼šè‡ªåŠ¨åˆ¤æ–­å†…å®¹ç›¸å…³æ€§å’Œè´¨é‡
- **å»é‡æœºåˆ¶**ï¼šURL å”¯ä¸€ç´¢å¼•é˜²é‡å¤

### ğŸ’¾ åˆ†ç¦»å¼å­˜å‚¨
- **MongoDB**ï¼šå…ƒæ•°æ® + æ‘˜è¦ï¼ˆé«˜æ€§èƒ½åˆ—è¡¨æŸ¥è¯¢ï¼‰
- **Elasticsearch**ï¼šå…¨æ–‡å†…å®¹ + å…¨æ–‡æœç´¢
- **Redis**ï¼šä»»åŠ¡é˜Ÿåˆ— + ç¼“å­˜
- **articleId å…³è”**ï¼šMongoDB `_id` â†” ES `articleId`

---

## æŠ€æœ¯æ¶æ„

### æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   HTTP è¯·æ±‚å±‚                        â”‚
â”‚  POST /api/crawler/crawl/zhihu                      â”‚
â”‚  POST /ai/strategy/generate                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ClaudeMCPService (ä¸šåŠ¡å±‚)               â”‚
â”‚  - analyzeContentRelevance()                        â”‚
â”‚  - classifyContent()                                â”‚
â”‚  - generateCrawlStrategy()                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼ submitTask(prompt)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ClaudeShellQueueService (é˜Ÿåˆ—å±‚)            â”‚
â”‚                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚  Task Queue (FIFO)              â”‚               â”‚
â”‚  â”‚  [Task1â†’Task2â†’Task3â†’Task4...]  â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                   â†“                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚  Worker Pool (Max 5)            â”‚               â”‚
â”‚  â”‚  Worker0: [busy] task-abc123   â”‚               â”‚
â”‚  â”‚  Worker1: [idle]                â”‚               â”‚
â”‚  â”‚  Worker2: [busy] task-def456   â”‚               â”‚
â”‚  â”‚  Worker3: [idle]                â”‚               â”‚
â”‚  â”‚  Worker4: [busy] task-ghi789   â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                   â†“                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼ executeClaudeShell()
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Claude CLI æ‰§è¡Œå±‚                       â”‚
â”‚  cat /tmp/prompt-{taskId}.txt |                     â”‚
â”‚  claude --print --output-format json                â”‚
â”‚  env: CLAUDE_SESSION_ID={taskId}  â† ä¼šè¯éš”ç¦»         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æŠ€æœ¯æ ˆ

```
åç«¯:  NestJS + TypeScript
AI:    Claude Code Shell + ä»»åŠ¡é˜Ÿåˆ—
æ•°æ®åº“: MongoDB + Elasticsearch + Redis
å‰ç«¯:  React 18 + Ant Design
```

---

## å­˜å‚¨æ¶æ„

### åˆ†ç¦»å¼å­˜å‚¨è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   çˆ¬è™« AI è·å–æ•°æ®                  â”‚
â”‚  { title, summary, fullContent, author, url, ... } â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   MongoDB      â”‚   â”‚ Elasticsearch    â”‚
â”‚ raw_content    â”‚   â”‚ raw_content      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ _id (ä¸»é”®)     â”‚â”€â”€â”€â”‚ articleId        â”‚ â† å…³è”
â”‚ title          â”‚   â”‚ title            â”‚
â”‚ summary â˜…      â”‚   â”‚ summary          â”‚
â”‚ hasFullContent â”‚   â”‚ fullContent â˜…    â”‚ â† å…¨æ–‡
â”‚ author         â”‚   â”‚ author           â”‚
â”‚ url (å”¯ä¸€)     â”‚   â”‚ platform, tags   â”‚
â”‚ likes, commentsâ”‚   â”‚ publishTime      â”‚
â”‚ platform, tags â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ publishTime    â”‚
â”‚ crawledAt      â”‚
â”‚ metadata       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æµå‘

```
1. çˆ¬è™«æŠ“å– â†’ {title, summary, fullContent, ...}
                â†“
2. ä¿å­˜åˆ° MongoDB â†’ è·å– _id (ObjectId)
                â†“
3. åŒæ­¥åˆ° ES â†’ {articleId: _id, fullContent, ...}
                â†“
4. æŸ¥è¯¢: MongoDB (åˆ—è¡¨) + ES (æœç´¢/å…¨æ–‡)
```

### ä¼˜åŠ¿å¯¹æ¯”

| åœºæ™¯ | MongoDB å…¨å­˜ | åˆ†ç¦»æ¶æ„ (ä¼˜åŒ–å) |
|------|-------------|-------------------|
| **åˆ—è¡¨æŸ¥è¯¢** | 150KB (30æ¡Ã—5KB) | 30KB (30æ¡Ã—1KB) âš¡ 80%â†“ |
| **å…¨æ–‡æœç´¢** | æ‰«æå…¨è¡¨ï¼Œæ…¢ | ES å€’æ’ç´¢å¼• âš¡ å¿«100å€ |
| **è¯¦æƒ…é¡µ** | æŸ¥è¯¢ä¸€æ¬¡ | MongoDBå…ƒæ•°æ® + ESå…¨æ–‡ |
| **ç›¸ä¼¼æ¨è** | éœ€è‡ªå®ç° | ES More Like This âš¡ |
| **çƒ­è¯ç»Ÿè®¡** | aggregationæ…¢ | ES aggregation âš¡ å¿«50å€ |

---

## Claude Shell é˜Ÿåˆ—æœåŠ¡

### ğŸ¯ æ ¸å¿ƒç‰¹æ€§

#### 1. **å¹¶å‘æ§åˆ¶**
- âœ… æœ€å¤š 5 ä¸ªå¹¶å‘ Worker
- âœ… FIFO å…ˆè¿›å…ˆå‡ºé˜Ÿåˆ—
- âœ… è‡ªåŠ¨è´Ÿè½½å‡è¡¡

#### 2. **æ­»é”é˜²æŠ¤**
- âœ… ä»»åŠ¡è¶…æ—¶æ£€æµ‹ï¼ˆé»˜è®¤ 2 åˆ†é’Ÿï¼‰
- âœ… å®šæœŸæ­»é”æ£€æŸ¥ï¼ˆæ¯ 10 ç§’ï¼‰
- âœ… è‡ªåŠ¨é‡Šæ”¾å¡æ­»çš„ Worker
- âœ… ç‹¬ç«‹ä¼šè¯ ID éš”ç¦»ï¼ˆ`CLAUDE_SESSION_ID`ï¼‰

#### 3. **é‡è¯•æœºåˆ¶**
- âœ… æœ€å¤šé‡è¯• 2 æ¬¡
- âœ… å¤±è´¥è‡ªåŠ¨é‡æ–°å…¥é˜Ÿ
- âœ… è¯¦ç»†é”™è¯¯æ—¥å¿—

#### 4. **ç›‘æ§ç»Ÿè®¡**
- âœ… å®æ—¶é˜Ÿåˆ—é•¿åº¦
- âœ… Worker ç¹å¿™çŠ¶æ€
- âœ… ä»»åŠ¡æˆåŠŸ/å¤±è´¥ç»Ÿè®¡
- âœ… è¶…æ—¶æ¬¡æ•°ç»Ÿè®¡

### æœ¬åœ° Claude å®ä¾‹æ¶æ„

#### æœ¬åœ°åŒ–æ‰§è¡Œæµç¨‹

```
å‰ç«¯è¯·æ±‚ â†’ AI Controller â†’ AI Service â†’ Claude MCP Service 
    â†“
Claude Shell Queue Service â†’ æœ¬åœ° Claude CLI å®ä¾‹ 
    â†“
Chrome DevTools MCP æœåŠ¡ â†’ æµè§ˆå™¨è‡ªåŠ¨åŒ–æ‰§è¡Œ
```

#### æ¶æ„ä¼˜åŠ¿

1. **å®Œå…¨æœ¬åœ°åŒ–**ï¼šæ‰€æœ‰ Claude å®ä¾‹éƒ½åœ¨æœ¬åœ°è¿è¡Œ
2. **MCP æœåŠ¡ç®¡ç†**ï¼šé€šè¿‡ Chrome DevTools MCP å®ç°æ›´å¥½çš„æ§åˆ¶
3. **å¹¶å‘å¤„ç†**ï¼šæ”¯æŒå¤šä¸ª Claude å®ä¾‹åŒæ—¶è¿è¡Œ
4. **ä»»åŠ¡é˜Ÿåˆ—**ï¼šé¿å…èµ„æºç«äº‰å’Œæ­»é”
5. **è¯¦ç»†æ—¥å¿—**ï¼šå®Œæ•´çš„æ‰§è¡Œè¿‡ç¨‹è®°å½•

#### æœ¬åœ°å®ä¾‹ç®¡ç†æœºåˆ¶

- **å®ä¾‹æ± ç®¡ç†**ï¼šæœ€å¤š 5 ä¸ªå¹¶å‘ Claude å®ä¾‹
- **ä¼šè¯éš”ç¦»**ï¼šæ¯ä¸ªä»»åŠ¡ä½¿ç”¨ç‹¬ç«‹çš„ `CLAUDE_SESSION_ID`
- **ä¸´æ—¶æ–‡ä»¶éš”ç¦»**ï¼šæ¯ä¸ªä»»åŠ¡ä½¿ç”¨ç‹¬ç«‹çš„ä¸´æ—¶æ–‡ä»¶
- **MCP æœåŠ¡é›†æˆ**ï¼šé€šè¿‡ Chrome DevTools MCP ç®¡ç†æµè§ˆå™¨ä¸Šä¸‹æ–‡

### æ­»é”é—®é¢˜è§£æ

#### âŒ ä¹‹å‰çš„æ­»é”åŸå› 

```
åœ¨ Claude Code ä¸­è¿è¡Œ
    â†“
å¯åŠ¨ NestJS åç«¯
    â†“
åç«¯è°ƒç”¨ `claude` å‘½ä»¤
    â†“
Claude å°è¯•å¯åŠ¨æ–°ä¼šè¯
    â†“
æ£€æµ‹åˆ°ä¸»ä¼šè¯å·²è¿è¡Œ
    â†“
ğŸ’€ æ­»é”ï¼šç­‰å¾…ä¼šè¯é‡Šæ”¾
```

**æŠ€æœ¯å±‚é¢ï¼š**
1. **å•ä¾‹ä¼šè¯å†²çª** - Claude Code åªå…è®¸ä¸€ä¸ªä¸»ä¼šè¯
2. **I/O ç®¡é“é˜»å¡** - `cat | claude` ç®¡é“ç­‰å¾…
3. **èµ„æºé”ç«äº‰** - `~/.claude/session.lock` è¢«å ç”¨

#### âœ… ç°åœ¨çš„è§£å†³æ–¹æ¡ˆ

| é˜²æŠ¤å±‚ | æœºåˆ¶ | é¿å…äº†ä»€ä¹ˆ |
|--------|------|-----------|
| **ä¼šè¯éš”ç¦»** | `CLAUDE_SESSION_ID=taskId` | âœ… é¿å…å•ä¾‹å†²çª |
| **å¹¶å‘é™åˆ¶** | æœ€å¤š 5 ä¸ª Worker | âœ… é¿å…èµ„æºè€—å°½ |
| **è¶…æ—¶ä¿æŠ¤** | 2 åˆ†é’Ÿå¼ºåˆ¶é‡Šæ”¾ | âœ… æ‰“ç ´æ­»é”å¾ªç¯ |
| **æ–‡ä»¶éš”ç¦»** | ç‹¬ç«‹ä¸´æ—¶æ–‡ä»¶ | âœ… é¿å…æ–‡ä»¶å†²çª |
| **å¥åº·æ£€æŸ¥** | æ¯ 10 ç§’æ£€æµ‹ | âœ… æå‰å‘ç°é—®é¢˜ |

### æ ¸å¿ƒæœºåˆ¶

#### 1. æ­»é”æ£€æµ‹

```typescript
// æ¯ 10 ç§’æ£€æŸ¥ä¸€æ¬¡
setInterval(() => {
  workers.forEach(worker => {
    if (worker.busy && (now - worker.startTime) > TIMEOUT * 0.8) {
      logger.warn('âš ï¸ Worker è¿è¡Œæ—¶é—´è¿‡é•¿');
    }
  });
}, 10000);
```

#### 2. è¶…æ—¶æ§åˆ¶

```typescript
// æ¯ä¸ªä»»åŠ¡è®¾ç½® 2 åˆ†é’Ÿè¶…æ—¶
task.timeout = setTimeout(() => {
  handleTaskTimeout(task); // å¼ºåˆ¶é‡Šæ”¾ Worker
}, 120000);
```

#### 3. ä¼šè¯éš”ç¦»

```typescript
execAsync(command, {
  env: {
    ...process.env,
    CLAUDE_SESSION_ID: taskId, // â† ç‹¬ç«‹ä¼šè¯ ID
  },
});
```

### é…ç½®å‚æ•°

åœ¨ `claude-shell-queue.service.ts` ä¸­å¯è°ƒæ•´ï¼š

```typescript
private readonly MAX_WORKERS = 5;           // æœ€å¤§å¹¶å‘æ•°
private readonly TASK_TIMEOUT = 120000;     // ä»»åŠ¡è¶…æ—¶ (æ¯«ç§’)
private readonly DEADLOCK_CHECK_INTERVAL = 10000;  // æ­»é”æ£€æŸ¥é—´éš”
private readonly MAX_RETRIES = 2;           // æœ€å¤§é‡è¯•æ¬¡æ•°
```

**è°ƒæ•´å»ºè®®ï¼š**

| åœºæ™¯ | MAX_WORKERS | TASK_TIMEOUT | è¯´æ˜ |
|------|-------------|--------------|------|
| é«˜å¹¶å‘ | 10 | 60000 | é€‚åˆç®€å•æŸ¥è¯¢ |
| æ ‡å‡† | 5 | 120000 | âœ… å½“å‰é»˜è®¤ |
| è°¨æ… | 3 | 180000 | å¤æ‚ä»»åŠ¡ï¼Œé¿å…è¶…è½½ |

---

## API æ¥å£

### AI æœåŠ¡

#### ç”Ÿæˆå†…å®¹
```bash
POST /ai/content/generate
{
  "rawData": [{"title": "çƒ­ç‚¹", "likes": 1000}],
  "strategy": {"style": "è½»æ¾æ´»æ³¼"}
}
```

#### ç”Ÿæˆç­–ç•¥
```bash
POST /ai/strategy/generate
{
  "timeframe": 7,
  "platforms": ["zhihu", "wechat"],
  "objectives": ["trending", "quality"]
}
```

#### åˆ†æå†…å®¹
```bash
POST /ai/content/analyze
{
  "content": "å¾…åˆ†æçš„å†…å®¹..."
}
```

#### æŸ¥çœ‹é˜Ÿåˆ—çŠ¶æ€ â­
```bash
GET /ai/queue/status
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "message": "é˜Ÿåˆ—çŠ¶æ€æŸ¥è¯¢æˆåŠŸ",
  "queueLength": 3,
  "workers": [
    {
      "id": 0,
      "busy": true,
      "currentTask": "abc12345",
      "duration": 45000,
      "taskCount": 15
    }
  ],
  "stats": {
    "totalTasks": 156,
    "completedTasks": 142,
    "failedTasks": 3,
    "timeouts": 1
  }
}
```

### çˆ¬è™«æœåŠ¡

#### å¯åŠ¨çˆ¬å–
```bash
POST /api/crawler/crawl/zhihu
{
  "keyword": "äººå·¥æ™ºèƒ½"
}
```

#### æŸ¥è¯¢ç»“æœ
```bash
GET /api/crawler/results?platform=zhihu&keyword=AI
```

---

## é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡

```bash
# MongoDB
MONGO_HOST=localhost
MONGO_PORT=27017
MONGO_USER=aiops
MONGO_PASSWORD=your_password
MONGO_DB=aiops

# Elasticsearch
ELASTICSEARCH_NODE=http://localhost:9200

# Redis
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=your_password

# Environment
NODE_ENV=development
```

### Docker Compose

å¯åŠ¨åŸºç¡€æœåŠ¡ï¼š

```bash
docker-compose up -d
```

åŒ…å«æœåŠ¡ï¼š
- MongoDB (27017)
- Elasticsearch (9200)
- Redis (6379)

---

## æ•…éšœæ’æŸ¥

### Q: ä»»åŠ¡ä¸€ç›´åœ¨é˜Ÿåˆ—ä¸­ä¸æ‰§è¡Œ

**ç—‡çŠ¶ï¼š**
```json
{
  "queueLength": 10,
  "workers": [
    { "busy": true, "duration": 150000 }  // è¶…æ—¶
  ]
}
```

**è§£å†³ï¼š**
1. æ£€æŸ¥æ—¥å¿—ï¼š`tail -f backend/logs/combined.log`
2. é‡å¯æœåŠ¡é‡Šæ”¾ Worker
3. è°ƒæ•´è¶…æ—¶é…ç½®

### Q: é¢‘ç¹è¶…æ—¶

**ç—‡çŠ¶ï¼š**
```json
{
  "stats": {
    "timeouts": 25  // è¶…æ—¶æ¬¡æ•°é«˜
  }
}
```

**è§£å†³ï¼š**
```typescript
// å¢åŠ è¶…æ—¶æ—¶é—´
private readonly TASK_TIMEOUT = 180000; // æ”¹ä¸º 3 åˆ†é’Ÿ
```

### Q: çˆ¬å–è¿”å› 0 ç¯‡

**æ£€æŸ¥æ¸…å•ï¼š**
1. æŸ¥çœ‹æ—¥å¿—æ˜¯å¦æœ‰é”™è¯¯
2. æ£€æŸ¥é˜Ÿåˆ—çŠ¶æ€ï¼š`curl http://localhost:3000/ai/queue/status`
3. ç¡®è®¤ Claude CLI å¯ç”¨ï¼š`which claude`

---

## é¡¹ç›®ç»“æ„

```
AIOps/
â”œâ”€â”€ backend/                    # NestJS åç«¯
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ modules/
â”‚       â”‚   â”œâ”€â”€ ai/            # AI æœåŠ¡
â”‚       â”‚   â”‚   â”œâ”€â”€ ai.service.ts
â”‚       â”‚   â”‚   â”œâ”€â”€ claude-mcp.service.ts
â”‚       â”‚   â”‚   â”œâ”€â”€ claude-shell-queue.service.ts â­
â”‚       â”‚   â”‚   â””â”€â”€ ai.controller.ts
â”‚       â”‚   â”œâ”€â”€ crawler/        # çˆ¬è™«æœåŠ¡
â”‚       â”‚   â”‚   â”œâ”€â”€ crawler.service.ts
â”‚       â”‚   â”‚   â””â”€â”€ smart-crawler.service.ts
â”‚       â”‚   â”œâ”€â”€ database/       # æ•°æ®åº“
â”‚       â”‚   â”‚   â”œâ”€â”€ database.service.ts
â”‚       â”‚   â”‚   â””â”€â”€ schemas/
â”‚       â”‚   â”‚       â”œâ”€â”€ raw-content.schema.ts â­
â”‚       â”‚   â”‚       â””â”€â”€ ...
â”‚       â”‚   â””â”€â”€ elasticsearch/  # æœç´¢å¼•æ“
â”‚       â”‚       â””â”€â”€ elasticsearch.service.ts â­
â”‚       â””â”€â”€ main.ts
â”œâ”€â”€ frontend/                   # React å‰ç«¯
â”œâ”€â”€ database/                   # æ•°æ®åº“åˆå§‹åŒ–
â”œâ”€â”€ docker-compose.yml          # Docker é…ç½®
â”œâ”€â”€ .env.example                # ç¯å¢ƒå˜é‡æ¨¡æ¿
â””â”€â”€ README.md                   # æœ¬æ–‡æ¡£
```

---

## æ ¸å¿ƒæ–‡ä»¶è¯´æ˜

### AI æœåŠ¡å±‚
- `claude-shell-queue.service.ts` - â­ é˜Ÿåˆ—ç®¡ç†æ ¸å¿ƒ
- `claude-mcp.service.ts` - MCP æœåŠ¡å°è£…
- `ai.service.ts` - AI ä¸šåŠ¡é€»è¾‘

### å­˜å‚¨å±‚
- `raw-content.schema.ts` - MongoDB Schema (å…ƒæ•°æ®+æ‘˜è¦)
- `elasticsearch.service.ts` - ES æœåŠ¡ (å…¨æ–‡æœç´¢)
- `database.service.ts` - æ•°æ®åº“æœåŠ¡ (åŒå†™é€»è¾‘)

### çˆ¬è™«å±‚
- `smart-crawler.service.ts` - æ™ºèƒ½çˆ¬è™«æœåŠ¡
- `crawler.service.ts` - çˆ¬è™«è°ƒåº¦æœåŠ¡

---

## ç›‘æ§ä¸è°ƒè¯•

### å®æ—¶ç›‘æ§é˜Ÿåˆ—

```bash
# æŒç»­ç›‘æ§é˜Ÿåˆ—çŠ¶æ€
watch -n 2 'curl -s http://localhost:3000/ai/queue/status | jq'
```

### æŸ¥çœ‹è¯¦ç»†æ—¥å¿—

```bash
# å¯ç”¨ Debug æ—¥å¿—
LOG_LEVEL=debug npm run start:dev

# æŸ¥çœ‹å®æ—¶æ—¥å¿—
tail -f backend/logs/combined.log | grep "é˜Ÿåˆ—\|Worker\|ä»»åŠ¡"
```

### æµ‹è¯• API

```bash
# æµ‹è¯•çˆ¬è™«
curl -X POST http://localhost:3000/api/crawler/crawl/zhihu \
  -H "Content-Type: application/json" \
  -d '{"keyword": "AI"}'

# æµ‹è¯• AI ç­–ç•¥ç”Ÿæˆ
curl -X POST http://localhost:3000/ai/strategy/generate \
  -H "Content-Type: application/json" \
  -d '{
    "timeframe": 7,
    "platforms": ["zhihu"],
    "objectives": ["trending"]
  }'
```

---

## æ€§èƒ½ä¼˜åŒ–

### æ•°æ®åº“ç´¢å¼•

```javascript
// MongoDB ç´¢å¼•
{ url: 1 }                     // å”¯ä¸€ç´¢å¼•ï¼Œå»é‡
{ platform: 1, publishTime: -1 } // å¹³å°+æ—¶é—´æŸ¥è¯¢
{ crawledAt: -1 }               // æ—¶é—´æ’åº
{ title: 'text', summary: 'text' } // å…¨æ–‡æœç´¢

// Elasticsearch ç´¢å¼•
{ articleId: keyword }          // MongoDB ID å…³è”
{ title, summary, fullContent: text } // å…¨æ–‡æœç´¢
{ platform, tags: keyword }     // ç²¾ç¡®è¿‡æ»¤
```

### ç¼“å­˜ç­–ç•¥

```typescript
// å¯é€‰ï¼šå¯ç”¨å“åº”ç¼“å­˜
private responseCache = new Map<string, string>();

async submitTask(prompt: string) {
  const hash = crypto.createHash('md5').update(prompt).digest('hex');

  if (this.responseCache.has(hash)) {
    return this.responseCache.get(hash)!;
  }

  const result = await this.executeTask(prompt);
  this.responseCache.set(hash, result);
  return result;
}
```

---

## ä¼˜åŠ¿æ€»ç»“

### ä¸ä¼ ç»Ÿæ–¹æ¡ˆå¯¹æ¯”

| ç‰¹æ€§ | ä¼ ç»Ÿæ–¹æ¡ˆ | æœ¬é¡¹ç›® |
|------|---------|--------|
| **AI æˆæœ¬** | $3-15/1M tokens | âœ… é›¶è´¹ç”¨ |
| **æ•°æ®éšç§** | ä¸Šä¼ äº‘ç«¯ | âœ… å®Œå…¨æœ¬åœ° |
| **å¹¶å‘æ§åˆ¶** | æ— é™åˆ¶ | âœ… é˜Ÿåˆ—ç®¡ç† |
| **æ­»é”é£é™©** | é«˜ | âœ… 5 å±‚é˜²æŠ¤ |
| **æœç´¢æ€§èƒ½** | MongoDB æ–‡æœ¬ç´¢å¼• | âœ… ES ä¸“ä¸šæœç´¢ |
| **æŸ¥è¯¢é€Ÿåº¦** | æ…¢ï¼ˆ5KBæ–‡æ¡£ï¼‰ | âœ… å¿« 5 å€ï¼ˆ1KBï¼‰ |
| **ç›‘æ§èƒ½åŠ›** | æ—  | âœ… å®æ—¶ API |

---

## è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

## è®¸å¯è¯

MIT License

---

**æ³¨æ„**ï¼šæœ¬é¡¹ç›®ä½¿ç”¨æœ¬åœ° Claude Code Shell è°ƒç”¨ï¼Œé€šè¿‡ä»»åŠ¡é˜Ÿåˆ—é¿å…æ­»é”ï¼Œå®ç°é›¶è´¹ç”¨ AI åŠŸèƒ½ã€‚

**æ›´æ–°æ—¥å¿—ï¼š**
- v3.0 (2025-11-27): æ·»åŠ  Claude Shell é˜Ÿåˆ—æœåŠ¡ï¼Œä¼˜åŒ–å­˜å‚¨æ¶æ„ï¼ˆMongoDB+ES åˆ†ç¦»ï¼‰
- v2.0 (2025-11-26): è¿ç§»åˆ°æœ¬åœ° MCP
- v1.0: åˆå§‹ç‰ˆæœ¬ï¼ˆäº‘ç«¯ APIï¼‰
